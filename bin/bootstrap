#!/bin/bash

function req {
    echo "java is required, on debian or ubuntu you can install that with:"
    echo ""
    echo "    sudo apt-get install openjdk-7-jdk"
    echo ""
    echo "redis is required, on debian or ubuntu you can install that with:"
    echo ""
    echo "    sudo apt-get install redis-server"
    echo ""
    exit 1
}

function checkbin {
    BIN=`which $1`
    if [ -z "$BIN" ]; then
        echo "ERROR: $1 not found, please install $1"
        exit 1
    fi
}

if [ ! -x bin/bootstrap ]; then
    echo "Please run bin/bootstrap from the project root."
    exit 1
fi

DATA_HOME="${HOME}/.local/share"
if [ -n "${XDG_DATA_HOME}" ]; then
    DATA_HOME="${XDG_DATA_HOME}"
fi

mkdir --parents "$DATA_HOME/waldmeta/tmp"

JAVA=`which java`
if [ -z "$JAVA" ]; then
    req
fi

REDIS=`which redis-cli`
if [ -z "$REDIS" ]; then
    req
fi

checkbin wget
checkbin sha1sum

if [ ! -d neo4j ]; then
    NEO_DIR="neo4j-community-2.1.6"
    NEO_FILENAME="$NEO_DIR-unix.tar.gz"
    DATA_TMP="$DATA_HOME/waldmeta/tmp"
    NEO_SHA1=`pwd`/bin/setup/neo4j.sha1sum

    cd "$DATA_TMP"
    if ! sha1sum --check "$NEO_SHA1"; then
        wget --continue "http://neo4j.com/artifact.php?name=$NEO_FILENAME" "--output-document=$NEO_FILENAME"
    fi

    if ! sha1sum --check "$NEO_SHA1"; then
        echo "ERROR: failed to download neo4j"
        exit 1
    fi
    cd -

    tar xfz "$DATA_TMP/$NEO_FILENAME" && mv "$NEO_DIR" neo4j

    if [ -x "neo4j/bin/neo4j" ]; then
        echo "neo4j downloaded, run \"neo4j/bin/neo4j start\" to run the database"
    else
        echo "ERROR: failed to download and unpack neo4j"
        exit 1
    fi
fi

# setup python virtualenv
bin/setup/python
